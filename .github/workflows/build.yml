name: "Build and Test"

# Build on pull requests and pushes to `main`. The PR builds will be
# non-blocking for now, but that is configured elsewhere.
on:
  pull_request:
  push:
    branches: [ 'main' ]

jobs:
  # Compiles and runs unit tests with macOS and Bazel
  # TODO(coryan) - currently it is just testing the runner
  macos-bazel:
    runs-on: 'macos-12'
    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'bazelbuild/setup-bazelisk@v2'
      - name: dump machine info
        run: |
          bazelisk --batch version >/dev/null 2>&1
          printf "%10s %s\n" "host:" "$(date -u -R)"
          printf "%10s %s\n" "kernel:" "$(uname -v)"
          printf "%10s %s\n" "os:" "$(sw_vers | xargs)"
          printf "%10s %s\n" "arch:" "$(arch)"
          printf "%10s %s\n" "cpus:" "$(sysctl -n hw.logicalcpu)"
          printf "%10s %s\n" "mem:" "$(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"
          printf "%10s %s\n" "term:" "${TERM-}"
          printf "%10s %s\n" "bash:" "$(bash --version 2>&1 | head -1)"
          printf "%10s %s\n" "clang:" "$(clang --version 2>&1 | head -1)"
          printf "%10s %s\n" "brew:" "$(brew --version 2>&1 | head -1)"
          printf "%10s %s\n" "branch:" "${BRANCH}"
          printf "%10s %s\n" "bazelisk:" "$(bazelisk version 2>&1 | head -1)"
          printf "%10s %s\n" "bazel:" "$(bazelisk --batch version 2>&1 | head -1)"
          printf "%10s %s\n" "=========="
          du -sh
          printf "%10s %s\n" "=========="
          df -h

  # Compiles and runs unit tests with macOS and Bazel
  # TODO(coryan) - currently it is just testing the XL runner
  macos-bazel-xl:
    runs-on: 'macos-12-xl'
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'bazelbuild/setup-bazelisk@v2'
      - id: 'auth'
        if: '!github.event.pull_request.head.repo.fork'
        name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v1'
        with:
          create_credentials_file: 'true'
          workload_identity_provider: 'projects/49427430084/locations/global/workloadIdentityPools/github-wif-pool/providers/github-wif-provider'
          service_account: 'github-actions@cloud-cpp-identity-federation.iam.gserviceaccount.com'
      - name: dump machine info
        run: |
          bazelisk --batch version >/dev/null 2>&1
          printf "%10s %s\n" "host:" "$(date -u -R)"
          printf "%10s %s\n" "kernel:" "$(uname -v)"
          printf "%10s %s\n" "os:" "$(sw_vers | xargs)"
          printf "%10s %s\n" "arch:" "$(arch)"
          printf "%10s %s\n" "cpus:" "$(sysctl -n hw.logicalcpu)"
          printf "%10s %s\n" "mem:" "$(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"
          printf "%10s %s\n" "term:" "${TERM-}"
          printf "%10s %s\n" "bash:" "$(bash --version 2>&1 | head -1)"
          printf "%10s %s\n" "clang:" "$(clang --version 2>&1 | head -1)"
          printf "%10s %s\n" "brew:" "$(brew --version 2>&1 | head -1)"
          printf "%10s %s\n" "branch:" "${BRANCH}"
          printf "%10s %s\n" "bazelisk:" "$(bazelisk version 2>&1 | head -1)"
          printf "%10s %s\n" "bazel:" "$(bazelisk --batch version 2>&1 | head -1)"
          printf "%10s %s\n" "=========="
          du -sh
          printf "%10s %s\n" "=========="
          df -h
          printf "%10s %s\n" "=========="
          printenv
      - name: run bazel fetch
        run: |
          args=(
            --google_credentials="${{ steps.auth.outputs.credentials_file_path }}"
            --remote_cache=https://storage.googleapis.com/cloud-cpp-gha-cache/bazel/${{ github.job }}
          )
          echo bazelisk fetch "${args[@]}" //...
      - name: run bazel build
        run: |
          args=(
            --google_credentials="${{ steps.auth.outputs.credentials_file_path }}"
            --remote_cache=https://storage.googleapis.com/cloud-cpp-gha-cache/bazel/${{ github.job }}
          )
          echo bazelisk build "${args[@]}" //google/cloud/storage/...
