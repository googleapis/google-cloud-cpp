name: "Build and Test"

# Build on pull requests and pushes to `main`. The PR builds will be
# non-blocking for now, but that is configured elsewhere.
on:
  pull_request:
  push:
    branches: [ 'main' ]

jobs:
  # Compiles and runs unit tests with macOS and Bazel
  # TODO(coryan) - currently it is just testing the XL runner
  bazel:
    strategy:
      matrix:
        runner: [macos-12-xl, macos-12]
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: 'actions/checkout@v3'
      - uses: 'bazelbuild/setup-bazelisk@v2'
      - name: Cache Bazel
        uses: actions/cache@v3
        with:
          path: |
            /private/var/tmp/_bazel_runner/
          key: ${{ runner.os }}-bazel-${{ hashFiles('.github/workflows/build.yml', '.bazelversion', '.bazelrc', 'WORKSPACE.bazel', 'bazel/google_cloud_cpp_deps.bzl') }}
          restore-keys: |
            ${{ runner.os }}-bazel-
      - name: dump machine info
        run: |
          bazelisk --batch version >/dev/null 2>&1
          printf "%10s %s\n" "host:" "$(date -u -R)"
          printf "%10s %s\n" "kernel:" "$(uname -v)"
          printf "%10s %s\n" "os:" "$(sw_vers | xargs)"
          printf "%10s %s\n" "arch:" "$(arch)"
          printf "%10s %s\n" "cpus:" "$(sysctl -n hw.logicalcpu)"
          printf "%10s %s\n" "mem:" "$(($(sysctl -n hw.memsize) / 1024 / 1024 / 1024)) GB"
          printf "%10s %s\n" "term:" "${TERM-}"
          printf "%10s %s\n" "bash:" "$(bash --version 2>&1 | head -1)"
          printf "%10s %s\n" "clang:" "$(clang --version 2>&1 | head -1)"
          printf "%10s %s\n" "brew:" "$(brew --version 2>&1 | head -1)"
          printf "%10s %s\n" "branch:" "${BRANCH}"
          printf "%10s %s\n" "bazelisk:" "$(bazelisk version 2>&1 | head -1)"
          printf "%10s %s\n" "bazel:" "$(bazelisk --batch version 2>&1 | head -1)"
          printf "%10s %s\n" "=========="
          du -sh
          printf "%10s %s\n" "=========="
          df -h
          printf "%10s %s\n" "=========="
      - name: run bazel fetch
        run: |
          args=(
          )
          bazelisk fetch "${args[@]}" //... || true
      - name: run bazel build
        run: |
          args=(
          )
          bazelisk build "${args[@]}" //google/cloud/storage/...
